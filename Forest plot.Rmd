---
title: "Quantitative Analysis"
output:
  pdf_document: default
  word_document: default
  html_document:
    df_print: paged
date: "2025-04-13"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 18, fig.height = 7, warning = F, error=F, message=F)

```


# Forest plot comparing consent models


```{r}
library(meta)
library(metafor)



# Study data
study <- c(
  "Ah Ra Lee et al. (2024)",
  "Antje Fischer-Rosinsky et al. (2025)",
  "Hans et al. (2024)",
  "Ewing et al. (2015)",
  "Thiel et al. (2015)",
  "Xiong et al. (2024)",
  "Muller et al. (2023)",
  "Muller et al. (2023)",
  "Pacyna et al. (2020)",
  "Huh et al. (2022)",
  "Sundby et al. (2019)",
  "Moser et al. (2024)",
  "Platt et al. (2014)",
  "Sanderson et al. (2017)",
  "Teunissen et al. (2022)",
  "Munshi et al. (2025)",
  "Haas et al. (2024)"
)

# Events = number of people who consented
events <- c(
  30,     # Ah Ra Lee: 100% of 30
  313,    # Antje: 313 consented
  68,     # Hans: 68 consented
  1161,   # Ewing Broad
  137,    # Thiel: 137 completed consent process
  59,      # Xiong: 59 agreed to receive platform
  630, # Muller et al. (2023)
  272, # Muller et al. (2023)
  1001,# Pacyna et al. (2020)
  247, # Huh et al. (2022)
  2047 ,# Sundby et al. (2019)
   264 ,# Moser et al. (2024)
  1740, # Platt et al. (2014)
   4371,# Sanderson et al. (2017)
  503, # Teunissen et al. (2022)
  271 ,# Munshi et al. (2025)
   91#Haas et al. (2024)
)

# Total participants
n <- c(  30,  1138,  151,  1528,  187,  99,902,902,1146, 259, 2406,435,3347,13000, 626,434,93 )

# Define study type (dynamic consent or broad consent)
study_type <- c("Dynamic", "Broad", "Broad", "Broad","Dynamic","Dynamic",
                "Broad","Dynamic","Dynamic","Dynamic","Dynamic","Broad",
                "Broad","Broad","Broad","Broad","Dynamic")

# Create meta-analysis object
meta_obj <- metaprop(
  event = events,
  n = n,
  studlab = study,
  sm = "PLOGIT",       # Logit transformation for proportions
  method = "Inverse",  # Inverse variance method
  common = FALSE,
  random = TRUE,
  method.random.ci = TRUE,         # Hartung-Knapp adjustment
  prediction = TRUE,
  title = "Consent Rates by Study"
)

# Define colors for dynamic and broad consent
study_colors <- ifelse(study_type == "Dynamic", "#ff7f0e", "#1f77b4")  

```




```{r, fig.width = 18, fig.height = 10, eval=FALSE}

# Open a graphics device explicitly if in RStudio
plot.new()
# Plot the forest plot
forest(
  meta_obj,
  sortvar = events / n,
  xlab = "Consent Rate",
  leftcols = c("studlab", "event", "n"),
  leftlabs = c("Study", "Events", "Total"),
  print.tau2 = TRUE,
  print.I2 = TRUE,
  colgap.studlab = "2mm",
  col.square = study_colors,  # Color for each square
  col.diamond = "darkgray",   # Common color for the diamond
  col.diamond.lines = "black",
  backtransf = TRUE,
   silent = TRUE
)

# Add the legend manually
legend("bottom", legend = c("Dynamic Consent", "Broad Consent"),
       fill = c("#ff7f0e", "#1f77b4"), cex = 1.2, horiz = TRUE)

```



```{r fig1, echo=FALSE, out.width="1000px", out.width="1.2\\linewidth", fig.align="center"}
knitr::include_graphics("C:\\Users\\GASER\\Pictures\\forest_plot.png")
```



# Funnel Plot (Publication Bias)





```{r funnel_plot, fig.width = 18, fig.height = 8}
# Enhanced funnel plot with improvements
funnel(
  meta_obj,
  xlab = "Effect Size (Logit-Transformed Proportion)",
  ylab = "Standard Error",
  col = study_colors,
  pch = 16,  # Solid circles instead of pch = 19
  studlab = FALSE,  # Turn off automatic labels, we'll add jittered ones
  cex = 1.2,  # Larger point size for better visibility
  xlim = c(-2.5, 4.5),  # Add some padding to x-axis
  ylim = c(-.3, 1.5),     # Invert y-axis range for better funnel appearance
  main = "Funnel Plot: Consent Type Studies",
  cex.main = 1.3,
  font.main = 1,  # Normal font weight for title
  bg = "white"    # White background for points
)

# Add intelligently positioned study labels
# Create a more spread out positioning system
set.seed(123)
n_studies <- length(meta_obj$TE)

# Create label positions with more aggressive spacing
label_x <- meta_obj$TE + runif(n_studies, -0.15, 0.15)  # Random horizontal offset
label_y <- meta_obj$seTE + runif(n_studies, -0.25, 0.1)  # Random vertical offset

# For studies that are too close together, spread them out more
for(i in 1:n_studies) {
  for(j in 1:n_studies) {
    if(i != j) {
      # If two labels are too close, move them apart
      dist_x <- abs(label_x[i] - label_x[j])
      dist_y <- abs(label_y[i] - label_y[j])
      
      if(dist_x < 0.2 & dist_y < 0.1) {
        # Move labels apart
        if(label_x[i] > label_x[j]) {
          label_x[i] <- label_x[i] + 0.25
          label_x[j] <- label_x[j] - 0.25
        } else {
          label_x[i] <- label_x[i] - 0.15
          label_x[j] <- label_x[j] + 0.15
        }
        if(label_y[i] > label_y[j]) {
          label_y[i] <- label_y[i] + 0.08
        } else {
          label_y[i] <- label_y[i] - 0.08
        }
      }
    }
  }
}

# Add the positioned labels with connecting lines to points
segments(meta_obj$TE, meta_obj$seTE, label_x, label_y, 
         col = "gray70", lty = 1, lwd = 0.5)

text(label_x, label_y, 
     labels = meta_obj$studlab, 
     cex = 1.2, 
     col = "black",
     font = 1,
     adj = 0.5)

# Add reference lines for effect size interpretation
abline(v = 0, col = "gray60", lty = 2, lwd = 1.5)  # No effect line
abline(v = c(-0.5, 0.5), col = "gray80", lty = 3)  # Small effect boundaries

# Improved legend with better positioning and styling
legend("topleft",
       legend = c("Dynamic Consent", "Broad Consent"),
       col = c("#ff7f0e", "#1f77b4"),
       horiz = TRUE,
       pch = 16,
       pt.cex = 1.3,
       cex = 1.1,
       bty = "n",
       bg = "white",
       box.col = "white")  

# Add subtitle for additional context
mtext("Standard error vs. effect size with study labels", 
      side = 3, line = 0.5, cex = 0.9, col = "gray40")

main = "Funnel Plot: Consent Type Studies\n(Point size proportional to study size)"
# )
```






